name: deploy-staging

on:
  workflow_dispatch:
  pull_request:
    branches: [ develop ]
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'ops/**'
      - '.github/workflows/deploy-staging.yml'
      - 'frontend/**'
      - 'users-api/**'
      - 'auth-api/**'
      - 'todos-api/**'
      - 'log-message-processor/**'
  push:
    branches: [ develop ]
    paths:
      - 'ops/**'
      - '.github/workflows/deploy-staging.yml'
      - 'frontend/**'
      - 'users-api/**'
      - 'auth-api/**'
      - 'todos-api/**'
      - 'log-message-processor/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - uses: actions/checkout@v4

      - name: Instalar Ansible y colección Docker
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint
          ansible-galaxy collection install community.docker

      - name: Agregar clave SSH (ENV staging)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Preflight TCP 22 (staging)
        shell: bash
        run: |
          set -e
          echo "Probe puerto 22..."
          timeout 8 bash -lc 'echo > /dev/tcp/${{ secrets.SSH_HOST }}/22' \
            && echo "OK puerto 22" || (echo "Fallo puerto 22"; exit 1)

      - name: Comprobar conectividad (appleboy)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 10s
          script_stop: true
          script: echo ok

      - name: Despliegue con Ansible (staging)
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
          ANSIBLE_STDOUT_CALLBACK: "yaml"
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          IMAGE_TAG: dev-${{ github.sha }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          ansible-playbook -vv -i ops/ansible/inventory/hosts.ini ops/ansible/playbooks/deploy.yml -l staging

      - name: Smoke test (staging)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /opt/microservice-app-stg

            # Guard: el compose debe existir (corta rápido si falta)
            test -f docker-compose.staging.yml || { echo "FALTA /opt/microservice-app-stg/docker-compose.staging.yml"; ls -la; exit 1; }

            # Espera a users-api UP (evita 502)
            until docker compose -f docker-compose.staging.yml exec -T users-api \
              sh -lc 'curl -sf http://localhost:8083/actuator/health | grep -q UP'; do
              echo "esperando users-api..."; sleep 3;
            done

            # JWT para endpoints protegidos
            JWT_SECRET=$(grep -E '^JWT_SECRET=' .env | cut -d= -f2-)
            [ -n "$JWT_SECRET" ] || { echo "Falta JWT_SECRET en .env"; exit 1; }

            TOKEN=$(SECRET="$JWT_SECRET" python3 - <<'PY'
            import os,json,base64,hmac,hashlib,time,base64 as b64
            def b64url(x): return b64.urlsafe_b64encode(x).rstrip(b'=')
            h={"alg":"HS256","typ":"JWT"}; now=int(time.time())
            p={"sub":"demo","name":"Demo User","iat":now,"nbf":now-5,"exp":now+3600,"roles":["USER"]}
            sec=os.environ["SECRET"].encode()
            hdr=b64url(json.dumps(h,separators=(',',':')).encode())
            pld=b64url(json.dumps(p,separators=(',',':')).encode())
            sig=b64url(hmac.new(sec, hdr+b'.'+pld, hashlib.sha256).digest())
            print((hdr+b'.'+pld+b'.'+sig).decode())
            PY
            )

            CODE_ROOT=$(curl -sS -o /dev/null -w "%{http_code}" http://localhost:8080/)
            CODE_USERS=$(curl -sS -H "Authorization: Bearer ${TOKEN}" -o /dev/null -w "%{http_code}" http://localhost:8080/api/users/)
            CODE_TODOS=$(curl -sS -H "Authorization: Bearer ${TOKEN}" -o /dev/null -w "%{http_code}" http://localhost:8080/api/todos/)

            echo "/ -> $CODE_ROOT | /api/users -> $CODE_USERS | /api/todos -> $CODE_TODOS"
            [ "$CODE_USERS" = "200" ] && [ "$CODE_TODOS" = "200" ]
